<!DOCTYPE html>
<html>
<head>
  <title>Chess</title>
  <meta charset="utf-8">
  <link type="text/css" rel="stylesheet" href="style.css">
</head>
<body>
  <section id="board"></section>
  <script src="Class.js"></script>
  <script src="Chess.js"></script>
  <script src="jquery-1.7.2.min.js"></script>
  <script src="handlebars-1.0.0.beta.6.js"></script>
  <script>
  function drawBoard(board) {
    var i;
    var c;
    var boardView = $('<div/>');
    var template = $('#square');
    var tmpl = Handlebars.compile(template.html());
    for (i = 0; i < board.length; i += 1) {
      var letter = $('<div>').appendTo(boardView);
      for (c = 0; c < board[i].length; c += 1) {
        letter.append($(tmpl(board[i][c])));
      }
    }
    $('#board')
      .html('')
      .append(boardView);
  }
  (function controllers ($) {
    var target = null;
    $('#board')
      .delegate('.square', 'click', function (e) {
        if (target) {
          try {
            Chess.Board.movePiece(target.piece, this.title);
            // if we're still executing, then the move was legal
            // better to detach() each pieceView and swap them...
            $(this.firstElementChild) // move "blank" piece to target
              .detach()
              .appendTo($('#' + target.position).parent());
            $('#' + target.position) // target piece
              .detach()
              .appendTo(this);
            // $(this).children('.piece')
            //   .detach()
            //   .appendTo($('#' + target.position).parent());
            // $('#' + target.position)
            //   .detach()
            //   .appendTo(this);

            // drawBoard(Chess.Board.board);
          } catch (ex) {
            alert(ex);
          } finally {
            $('.target').removeClass('target');
            target = null;
            return;
          }
        }
        $(this).addClass('target');
        target = {
          piece: Chess.Pieces[this.firstElementChild.id],
          position: this.firstElementChild.id
        };
      });
  }(jQuery)); 
  setup();
  setTimeout(function () {
    drawBoard(Chess.Board.board);
  }, 0);
  </script>
  <script type="text/x-handlerbars" id="square">
  <div class="square" title="{{label}}">
    <div class="piece {{team}} {{type}}" id="{{occupiedBy}}"></div>
  </div>
  </script>
</body>
</html>
